<!DOCTYPE html>
<html lang="ru">
  <head>
    <link
      rel="icon"
      href="{{ url_for('static', filename='photo/image.png') }}"
    />
    <meta charset="UTF-8" />
    <title>–°—Ç—Ä–∞–Ω–∏—á–∫–∞ {{ animal.name }}a</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='pets_stat_users.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="animal-title">{{ animal.name }}</h1>

      <div class="main-content">
        <div class="stats">
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">–í–∏–¥</span>
              <span class="stat-value">{{ animal.species }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">–ü–æ—Ä–æ–¥–∞</span>
              <span class="stat-value">{{ animal.breed }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">–í–æ–∑—Ä–∞—Å—Ç</span>
              <span class="stat-value">{{ animal.age }} {{ animal.age | russian_years }} </span>
            </div>
            <div class="stat-item">
              <span class="stat-label">–í–µ—Å</span>
              <span class="stat-value">{{ animal.weight }} –∫–≥</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">–†–æ—Å—Ç</span>
              <span class="stat-value">{{ animal.height }} –º</span>
            </div>
          </div>
          <div class="animal-description">{{ animal.description }}</div>
        </div>

        <div class="animal-photo">
          <img src="{{ animal_photo_url }}" alt="–§–æ—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ" />
        </div>
      </div>
    </div>

    <div class="activity-timeline">
      <h2>–¢–æ–ø-3 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∏—Ç–æ–º—Ü–∞</h2>

      {% if activity_data|length == 0 %}
        <div class="no-activities">
          –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        </div>
      {% else %}
        <div class="activity-cards">
          {% for activity in activity_data %}
            <div class="activity-card">
              <div class="card-medals">
                {% if loop.index == 1 %}
                  <span class="medal-icons">ü•á</span>
                  <span class="card-place">–ó–æ–ª–æ—Ç–æ</span>
                {% elif loop.index == 2 %}
                  <span class="medal-icons">ü•à</span>
                  <span class="card-place">–°–µ—Ä–µ–±—Ä–æ</span>
                {% elif loop.index == 3 %}
                  <span class="medal-icons">ü•â</span>
                  <span class="card-place">–ë—Ä–æ–Ω–∑–∞</span>
                {% else %}
                  <span class="medal-icons">üéñ</span>
                  <span class="card-place">{{ loop.index }} –º–µ—Å—Ç–æ</span>
                {% endif %}
              </div>
              <div class="card-content">
                <div class="card-title">
                  {{ activity.activityType }}
                </div>
                <div class="card-duration">
                  {{ activity.duration }} —Å–µ–∫
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>


    <div class="video-section" id="videoSection">
      <h2>–í–∏–¥–µ–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
      <div class="video-timings-wrapper">
        <div class="video-container">
          <video id="activityVideo" controls>
            <source src="{{ video }}" />
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
          </video>
        </div>
        <div class="activities-container">
          {% if grouped_activities %}
            {% for activity_type, times in grouped_activities.items() %}
              <div class="activity-column">
                <h3>{{ activity_type }}</h3>
                <ul class="time-list">
                  {% for time in times %}
                  <li>
                    <button
                      type="button"
                      class="timing-btn"
                      data-start="{{ time.seconds }}"
                    >
                      {{ time.formatted }}
                    </button>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
            {% else %}
            <!-- –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div class="empty-icon">‚ö†</div>
            <p class="no-activities-text">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
          {% endif %}
        </div>
      </div>

    </div>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal">
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
        <p>
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–∞–Ω–Ω–æ–º –∂–∏–≤–æ—Ç–Ω–æ–º? –í–µ—Ä–Ω—É—Ç—å –∏—Ö
          –±—É–¥–µ—Ç –Ω–µ–ª—å–∑—è.
        </p>
        <div class="modal-buttons">
          <button id="modalCancel" type="button">–û—Ç–º–µ–Ω–∞</button>
          <form
            action="{{ url_for('delete_animal', animal_id=animal_id) }}"
            method="POST"
          >
            <button type="submit" id="modalConfirm">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      const modalOverlay = document.getElementById("modalOverlay");
      const modalCancel = document.getElementById("modalCancel");

      modalCancel.addEventListener("click", function () {
        modalOverlay.style.display = "none";
      });

      const video = document.getElementById("activityVideo");
      let isVideoReady = false;

      video.addEventListener("loadedmetadata", () => {
        isVideoReady = true;
        console.log("Video duration:", video.duration);
      });

      video.addEventListener("error", () => {
        console.error("Error loading video:", video.error);
      });

      document.querySelectorAll(".timing-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const startTime = parseInt(btn.dataset.start);
          console.log("Attempting to seek to:", startTime);

          const seekAndPlay = () => {
            if (video.readyState > 0) {
              video.currentTime = startTime;
              video.play().catch((error) => {
                console.error("Playback failed:", error);
              });
              return true;
            }
            return false;
          };

          if (!seekAndPlay()) {
            const waitForReady = setInterval(() => {
              if (seekAndPlay()) {
                clearInterval(waitForReady);
              }
            }, 100);
          }

          document.getElementById("videoSection").scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        });
      });

      video.controls = true;
      video.preload = "metadata";

      video.addEventListener("timeupdate", () => {
        console.debug("Current time:", video.currentTime);
      });

      video.addEventListener("seeked", () => {
        console.log("Seek completed");
      });
    </script>
  </body>
</html>
